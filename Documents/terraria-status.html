<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>泰拉瑞亚服务器状态</title>
  <style>
    :root {
      --bg-color: #f5f5f5;
      --text-color: #333;
      --border-color: #ddd;
      --header-bg: #3a3a3a;
      --header-text: #fff;
      --online-color: #28a745;
      --offline-color: #dc3545;
      --panel-bg: #fff;
      --panel-shadow: rgba(0, 0, 0, 0.1);
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      line-height: 1.6;
      color: var(--text-color);
      background-color: var(--bg-color);
      margin: 0;
      padding: 0;
    }
    
    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }
    
    header {
      background-color: var(--header-bg);
      color: var(--header-text);
      padding: 20px 0;
      text-align: center;
      border-radius: 5px 5px 0 0;
      margin-bottom: 20px;
    }
    
    h1, h2, h3 {
      margin-top: 0;
    }
    
    .status-panel {
      background-color: var(--panel-bg);
      border-radius: 5px;
      box-shadow: 0 2px 5px var(--panel-shadow);
      padding: 20px;
      margin-bottom: 20px;
    }
    
    .server-status {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }
    
    .status-indicator {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      margin-right: 10px;
    }
    
    .status-online {
      background-color: var(--online-color);
    }
    
    .status-offline {
      background-color: var(--offline-color);
    }
    
    .info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }
    
    .info-item {
      background-color: #f8f9fa;
      padding: 15px;
      border-radius: 4px;
      border: 1px solid var(--border-color);
    }
    
    .info-label {
      font-weight: 600;
      margin-bottom: 5px;
      color: #666;
    }
    
    .info-value {
      font-size: 18px;
      font-weight: 500;
    }
    
    .history-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    
    .history-table th,
    .history-table td {
      padding: 10px;
      text-align: left;
      border-bottom: 1px solid var(--border-color);
    }
    
    .history-table th {
      background-color: #f0f0f0;
    }
    
    .history-table tr:hover {
      background-color: #f5f5f5;
    }
    
    .last-update {
      text-align: right;
      font-size: 0.9em;
      color: #666;
      font-style: italic;
      margin-top: 5px;
    }
    
    .loading {
      text-align: center;
      padding: 50px;
      font-style: italic;
      color: #666;
    }
    
    .error-message {
      background-color: #fceded;
      color: var(--offline-color);
      padding: 15px;
      border-radius: 5px;
      border: 1px solid #f8d7da;
      margin-bottom: 20px;
    }
    
    .refresh-button {
      display: inline-block;
      padding: 8px 15px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: background-color 0.3s;
    }
    
    .refresh-button:hover {
      background-color: #0069d9;
    }
    
    footer {
      text-align: center;
      margin-top: 20px;
      font-size: 0.9em;
      color: #666;
    }
    
    @media (max-width: 600px) {
      .info-grid {
        grid-template-columns: 1fr;
      }
      
      .history-table thead {
        display: none;
      }
      
      .history-table, .history-table tbody, .history-table tr, .history-table td {
        display: block;
        width: 100%;
      }
      
      .history-table tr {
        margin-bottom: 15px;
        border: 1px solid var(--border-color);
        border-radius: 4px;
      }
      
      .history-table td {
        text-align: right;
        position: relative;
        padding-left: 50%;
        border-bottom: 1px solid #eee;
      }
      
      .history-table td:before {
        content: attr(data-label);
        position: absolute;
        left: 10px;
        width: 45%;
        text-align: left;
        font-weight: bold;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>泰拉瑞亚服务器状态</h1>
    </header>
    
    <div id="loadingMessage" class="loading">
      <p>加载服务器状态中...</p>
    </div>
    
    <div id="errorMessage" class="error-message" style="display: none;">
      <p id="errorMessageText">加载服务器状态时出错。请稍后再试。</p>
      <p>可能的原因:</p>
      <ul>
        <li>GitHub API限制</li>
        <li>Issue编号或仓库配置错误</li>
        <li>服务器尚未发送状态更新</li>
      </ul>
      <p><button id="retryButton" class="refresh-button">重试</button></p>
    </div>
    
    <div id="statusContent" style="display: none;">
      <div class="status-panel">
        <div class="server-status">
          <div id="statusIndicator" class="status-indicator"></div>
          <h2 id="statusText">服务器状态</h2>
        </div>
        
        <div class="info-grid">
          <div class="info-item">
            <div class="info-label">当前地图</div>
            <div id="worldName" class="info-value">未知</div>
          </div>
          
          <div class="info-item">
            <div class="info-label">在线玩家</div>
            <div id="playerCount" class="info-value">0</div>
          </div>
          
          <div class="info-item">
            <div class="info-label">模组数量</div>
            <div id="modCount" class="info-value">0</div>
          </div>
          
          <div class="info-item">
            <div class="info-label">运行时间</div>
            <div id="uptimeValue" class="info-value">--</div>
          </div>
        </div>
        
        <div class="last-update">
          <button id="refreshButton" class="refresh-button">刷新</button>
          <span>最后更新: <span id="lastUpdateTime">--</span></span>
        </div>
      </div>
      
      <div class="status-panel">
        <h3>最近状态变更历史</h3>
        <div id="historyTableContainer">
          <table class="history-table">
            <thead>
              <tr>
                <th>时间</th>
                <th>事件</th>
                <th>状态</th>
                <th>玩家数</th>
              </tr>
            </thead>
            <tbody id="historyTableBody">
              <!-- 历史记录会在这里动态生成 -->
            </tbody>
          </table>
        </div>
      </div>
      
      <div class="status-panel">
        <h3>服务器信息</h3>
        <div class="info-grid">
          <div class="info-item">
            <div class="info-label">服务器版本</div>
            <div id="serverVersion" class="info-value">未知</div>
          </div>
          
          <div class="info-item">
            <div class="info-label">网络模式</div>
            <div id="networkMode" class="info-value">Steam</div>
          </div>
          
          <div class="info-item">
            <div class="info-label">最近启动时间</div>
            <div id="lastStartTime" class="info-value">--</div>
          </div>
          
          <div class="info-item">
            <div class="info-label">下次计划重启</div>
            <div id="nextRestartTime" class="info-value">--</div>
          </div>
        </div>
      </div>
    </div>
    
    <footer>
      <p>© 2025 泰拉瑞亚服务器管理面板 | 状态每15分钟自动更新</p>
    </footer>
  </div>
  
  <script>
    // 配置信息
    const config = {
      owner: 'wanglrebe',
      repo: 'wanglrebe.github.io', // 确保这是正确的仓库名
      issueNumber: 1,  // 请确保使用正确的Issue编号
      refreshInterval: 5 * 60 * 1000 // 5分钟自动刷新
    };
    
    // 页面加载时获取数据
    document.addEventListener('DOMContentLoaded', () => {
      // 尝试从GitHub获取数据
      fetchServerStatus();
      
      // 设置定期刷新
      setInterval(fetchServerStatus, config.refreshInterval);
      
      // 刷新按钮点击事件
      document.getElementById('refreshButton').addEventListener('click', fetchServerStatus);
      
      // 重试按钮点击事件
      document.getElementById('retryButton').addEventListener('click', fetchServerStatus);
      
      // 添加一个临时数据按钮 - 仅用于测试
      const tempDataBtn = document.createElement('button');
      tempDataBtn.textContent = '使用演示数据';
      tempDataBtn.className = 'refresh-button';
      tempDataBtn.style.marginRight = '10px';
      tempDataBtn.addEventListener('click', () => {
        console.log('使用演示数据');
        const demoData = getDemoStatusData();
        updateStatusDisplay(demoData);
        showContent();
      });
      
      // 将按钮插入到刷新按钮前面
      const refreshButton = document.getElementById('refreshButton');
      refreshButton.parentNode.insertBefore(tempDataBtn, refreshButton);
    });
    
    /**
     * 获取演示状态数据
     * @returns {Object} 演示状态数据
     */
    function getDemoStatusData() {
      const now = new Date();
      const oneHourAgo = new Date(now.getTime() - 60 * 60 * 1000);
      const twoHoursAgo = new Date(now.getTime() - 2 * 60 * 60 * 1000);
      
      return {
        currentStatus: {
          running: true,
          playerCount: 3,
          worldName: "MyTerrariaWorld",
          modCount: 15,
          serverVersion: "tModLoader v2023.x",
          uptime: 7200, // 2小时
          lastUpdate: now.toISOString()
        },
        history: [
          {
            timestamp: now.toISOString(),
            reason: "定时更新",
            status: {
              running: true,
              playerCount: 3,
              worldName: "MyTerrariaWorld",
              modCount: 15,
              uptime: 7200
            }
          },
          {
            timestamp: oneHourAgo.toISOString(),
            reason: "玩家数量变化",
            status: {
              running: true,
              playerCount: 2,
              worldName: "MyTerrariaWorld",
              modCount: 15,
              uptime: 3600
            }
          },
          {
            timestamp: twoHoursAgo.toISOString(),
            reason: "服务器启动",
            status: {
              running: true,
              playerCount: 0,
              worldName: "MyTerrariaWorld",
              modCount: 15,
              uptime: 0
            }
          }
        ]
      };
    }
    
    /**
     * 获取服务器状态
     */
    async function fetchServerStatus() {
      showLoading(true);
      
      try {
        // 直接获取Issue页面HTML而不是使用API
        const issueUrl = `https://github.com/${config.owner}/${config.repo}/issues/${config.issueNumber}`;
        console.log(`正在请求页面: ${issueUrl}`);
        
        // 使用CORS代理来获取GitHub页面
        // 注意：在实际部署前需要替换为可靠的CORS代理
        const corsProxyUrl = `https://corsproxy.io/?${encodeURIComponent(issueUrl)}`;
        
        const response = await fetch(corsProxyUrl);
        
        if (!response.ok) {
          throw new Error(`获取Issue页面失败: ${response.status}`);
        }
        
        const htmlContent = await response.text();
        console.log('成功获取Issue页面内容');
        
        // 检查响应HTML内容的一小部分，帮助调试
        const htmlPreview = htmlContent.substring(0, 200) + '...';
        console.log('HTML预览:', htmlPreview);
        
        // 检查HTML中是否包含关键字，帮助理解页面内容
        const hasJsonBlock = htmlContent.includes('```json');
        const hasPreTag = htmlContent.includes('<pre>');
        const hasCodeTag = htmlContent.includes('<code>');
        const hasCommentBody = htmlContent.includes('js-comment-body');
        const hasMarkdownBody = htmlContent.includes('markdown-body');
        
        console.log('页面内容检查:', {
          hasJsonBlock,
          hasPreTag,
          hasCodeTag,
          hasCommentBody,
          hasMarkdownBody
        });
        
        // 检查页面中的代码块数量
        const preCount = (htmlContent.match(/<pre/g) || []).length;
        const codeCount = (htmlContent.match(/<code/g) || []).length;
        console.log(`页面中包含 ${preCount} 个<pre>标签和 ${codeCount} 个<code>标签`);
        
        // 从HTML中提取JSON数据
        const statusData = extractDataFromHtml(htmlContent);
        
        if (statusData) {
          console.log('成功提取状态数据:', statusData);
          updateStatusDisplay(statusData);
          showContent();
        } else {
          throw new Error('无法从页面中提取状态数据');
        }
      } catch (error) {
        console.error('获取服务器状态失败:', error);
        showError(error.message);
      }
    }
    
    /**
     * 从HTML内容中提取状态数据
     * @param {string} html - Issue页面的HTML内容
     * @returns {Object|null} 解析出的状态数据或null
     */
    function extractDataFromHtml(html) {
      try {
        console.log('开始从HTML中提取数据...');
        
        // 创建一个临时的DOM解析器
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        
        // 尝试从meta标签中获取信息
        console.log('尝试从meta标签中提取信息...');
        const metaDescription = doc.querySelector('meta[property="og:description"]') || 
                              doc.querySelector('meta[name="description"]');
        
        if (metaDescription) {
          const content = metaDescription.getAttribute('content');
          console.log('找到meta描述:', content.substring(0, 100) + '...');
          
          // 尝试从meta描述中提取状态信息
          const currentStatus = {
            running: content.includes('🟢 运行中'),
            playerCount: 0,
            worldName: '未知',
            modCount: 0,
            serverVersion: '未知',
            lastUpdate: new Date().toISOString()
          };
          
          // 尝试提取玩家数量
          const playerMatch = content.match(/在线玩家[:：]\s*(\d+)/);
          if (playerMatch && playerMatch[1]) {
            currentStatus.playerCount = parseInt(playerMatch[1], 10);
            console.log('找到玩家数量:', currentStatus.playerCount);
          }
          
          // 尝试提取世界名称
          const worldMatch = content.match(/世界名称[:：]\s*([^在\n]+)/);
          if (worldMatch && worldMatch[1]) {
            currentStatus.worldName = worldMatch[1].trim();
            console.log('找到世界名称:', currentStatus.worldName);
          }
          
          // 尝试提取模组数量
          const modMatch = content.match(/模组数量[:：]\s*(\d+)/);
          if (modMatch && modMatch[1]) {
            currentStatus.modCount = parseInt(modMatch[1], 10);
            console.log('找到模组数量:', currentStatus.modCount);
          }
          
          // 尝试提取服务器版本
          const versionMatch = content.match(/服务器版本[:：]\s*([^运\n]+)/);
          if (versionMatch && versionMatch[1]) {
            currentStatus.serverVersion = versionMatch[1].trim();
            console.log('找到服务器版本:', currentStatus.serverVersion);
          }
          
          // 尝试提取最后更新时间
          const updateMatch = content.match(/最后更新[:：]\s*([^当\n]+)/);
          if (updateMatch && updateMatch[1]) {
            try {
              currentStatus.lastUpdate = new Date(updateMatch[1].trim()).toISOString();
              console.log('找到最后更新时间:', currentStatus.lastUpdate);
            } catch (e) {
              console.log('解析时间失败, 使用当前时间');
            }
          }
          
          // 尝试提取运行时间
          const uptimeMatch = content.match(/运行时间[:：]\s*(\d+)小时(\d+)分钟/);
          if (uptimeMatch && uptimeMatch[1] && uptimeMatch[2]) {
            const hours = parseInt(uptimeMatch[1], 10);
            const minutes = parseInt(uptimeMatch[2], 10);
            currentStatus.uptime = (hours * 3600) + (minutes * 60);
            console.log('找到运行时间:', currentStatus.uptime, '秒');
          }
          
          // 尝试解析历史记录
          const history = [];
          
          // 使用正则表达式匹配所有历史记录行
          // 格式类似于 "2025/4/7 01:25:43 服务器启动 🟢 运行中 0"
          const historyRegex = /(\d{4}\/\d{1,2}\/\d{1,2}\s+\d{1,2}:\d{1,2}:\d{1,2})\s+([^\s]+)\s+(🟢 运行中|🔴 离线)\s+(\d+)/g;
          let match;
          
          while ((match = historyRegex.exec(content)) !== null) {
            try {
              const timestamp = new Date(match[1]).toISOString();
              const reason = match[2];
              const running = match[3].includes('运行中');
              const playerCount = parseInt(match[4], 10);
              
              history.push({
                timestamp,
                reason,
                status: {
                  running,
                  playerCount,
                  worldName: currentStatus.worldName,
                  modCount: currentStatus.modCount
                }
              });
              
              console.log('找到历史记录:', match[1], reason);
            } catch (e) {
              console.error('解析历史记录失败:', e);
            }
          }
          
          // 反转历史记录，使最新的在前面
          history.reverse();
          
          console.log(`提取完成，找到 ${history.length} 条历史记录`);
          
          // 尝试从JSON部分解析完整数据
          try {
            const jsonMatch = content.match(/详细状态数据 \(JSON\)([\s\S]*?)(\{.*\})/);
            if (jsonMatch && jsonMatch[2]) {
              const jsonText = jsonMatch[2].replace(/&quot;/g, '"');
              console.log('找到JSON数据:', jsonText.substring(0, 100) + '...');
              
              try {
                const jsonData = JSON.parse(jsonText);
                console.log('成功解析JSON数据');
                return jsonData;
              } catch (e) {
                console.error('JSON解析失败:', e);
                // 继续使用从meta提取的数据
              }
            }
          } catch (e) {
            console.error('提取JSON失败:', e);
          }
          
          return {
            currentStatus,
            history: history.length > 0 ? history : []
          };
        } else {
          console.log('未找到meta描述标签，尝试其他方法...');
        }
        
        console.log('从页面无法提取有效数据，返回基本状态');
        // 如果所有方法都失败，返回一个基本状态
        return {
          currentStatus: {
            running: false,
            playerCount: 0,
            worldName: '未知',
            modCount: 0,
            serverVersion: '未知',
            lastUpdate: new Date().toISOString(),
            uptime: null
          },
          history: []
        };
      } catch (error) {
        console.error('从HTML中提取数据失败:', error);
        return null;
      }
    }
    

    
    /**
     * 更新状态显示
     * @param {Object} data - 状态数据
     */
    function updateStatusDisplay(data) {
      const { currentStatus, history } = data;
      
      // 更新状态指示器
      const statusIndicator = document.getElementById('statusIndicator');
      const statusText = document.getElementById('statusText');
      
      if (currentStatus.running) {
        statusIndicator.className = 'status-indicator status-online';
        statusText.textContent = '服务器在线';
      } else {
        statusIndicator.className = 'status-indicator status-offline';
        statusText.textContent = '服务器离线';
      }
      
      // 更新基本信息
      document.getElementById('worldName').textContent = currentStatus.worldName || '未知';
      document.getElementById('playerCount').textContent = currentStatus.playerCount;
      document.getElementById('modCount').textContent = currentStatus.modCount;
      document.getElementById('serverVersion').textContent = currentStatus.serverVersion || '未知';
      
      // 格式化运行时间
      if (currentStatus.uptime !== null) {
        const hours = Math.floor(currentStatus.uptime / 3600);
        const minutes = Math.floor((currentStatus.uptime % 3600) / 60);
        document.getElementById('uptimeValue').textContent = `${hours}小时${minutes}分钟`;
      } else {
        document.getElementById('uptimeValue').textContent = '--';
      }
      
      // 更新最后更新时间
      const lastUpdate = new Date(currentStatus.lastUpdate);
      document.getElementById('lastUpdateTime').textContent = lastUpdate.toLocaleString();
      
      // 查找最近的服务器启动时间
      if (history && history.length > 0) {
        // 寻找最近的服务器启动事件
        const startEvent = [...history].reverse().find(item => 
          item.reason === '服务器启动' && item.status.running === true
        );
        
        if (startEvent) {
          const startTime = new Date(startEvent.timestamp);
          document.getElementById('lastStartTime').textContent = startTime.toLocaleString();
        }
        
        // 可以从状态历史中提取其他信息，如网络模式等
        // 这里仅作示例
        document.getElementById('networkMode').textContent = 'Steam';
        document.getElementById('nextRestartTime').textContent = '未计划';
      }
      
      // 更新历史记录表格
      updateHistoryTable(history);
    }
    
    /**
     * 更新历史记录表格
     * @param {Array} history - 历史记录数组
     */
    function updateHistoryTable(history) {
      const tableBody = document.getElementById('historyTableBody');
      tableBody.innerHTML = '';
      
      if (!history || history.length === 0) {
        const row = document.createElement('tr');
        const cell = document.createElement('td');
        cell.colSpan = 4;
        cell.textContent = '暂无历史记录';
        cell.style.textAlign = 'center';
        row.appendChild(cell);
        tableBody.appendChild(row);
        return;
      }
      
      // 取最近的10条记录
      const recentHistory = history.slice(-10).reverse();
      
      recentHistory.forEach(item => {
        const row = document.createElement('tr');
        
        // 时间列
        const timeCell = document.createElement('td');
        timeCell.setAttribute('data-label', '时间');
        const time = new Date(item.timestamp).toLocaleString();
        timeCell.textContent = time;
        row.appendChild(timeCell);
        
        // 事件列
        const eventCell = document.createElement('td');
        eventCell.setAttribute('data-label', '事件');
        eventCell.textContent = item.reason;
        row.appendChild(eventCell);
        
        // 状态列
        const statusCell = document.createElement('td');
        statusCell.setAttribute('data-label', '状态');
        statusCell.textContent = item.status.running ? '在线' : '离线';
        row.appendChild(statusCell);
        
        // 玩家数列
        const playerCell = document.createElement('td');
        playerCell.setAttribute('data-label', '玩家数');
        playerCell.textContent = item.status.playerCount;
        row.appendChild(playerCell);
        
        tableBody.appendChild(row);
      });
    }
    
    /**
     * 显示/隐藏加载信息
     * @param {boolean} show - 是否显示
     */
    function showLoading(show) {
      document.getElementById('loadingMessage').style.display = show ? 'block' : 'none';
      if (show) {
        document.getElementById('errorMessage').style.display = 'none';
      }
    }
    
    /**
     * 显示错误信息
     * @param {string} message - 错误消息
     */
    function showError(message = '加载服务器状态时出错。请稍后再试。') {
      document.getElementById('loadingMessage').style.display = 'none';
      document.getElementById('errorMessage').style.display = 'block';
      document.getElementById('errorMessageText').textContent = message;
      document.getElementById('statusContent').style.display = 'none';
      
      // 确保重试按钮有正确的监听器
      document.getElementById('retryButton').addEventListener('click', fetchServerStatus);
    }
    
    /**
     * 显示内容
     */
    function showContent() {
      document.getElementById('loadingMessage').style.display = 'none';
      document.getElementById('errorMessage').style.display = 'none';
      document.getElementById('statusContent').style.display = 'block';
    }
  </script>
</body>
</html>
